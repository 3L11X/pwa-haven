(()=>{"use strict";function e(e,t=e.iceGatheringState){return"complete"!==t&&new Promise((t=>{e.addEventListener("icegatheringstatechange",(()=>"complete"===e.iceGatheringState&&t()))}))}class t{constructor(t={}){let{polite:a=!0,trickle:i=!0,quality:o={}}=t,{port1:r,port2:s}=new MessageChannel,c=e=>s.postMessage(JSON.stringify(e));const l=new RTCPeerConnection({iceServers:t?.iceServers||[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]}),d=new AbortController,u={signal:d.signal};l.addEventListener("iceconnectionstatechange",(()=>{"disconnected"!==l.iceConnectionState&&"failed"!==l.iceConnectionState||d.abort()}),u);const p=l.createDataChannel("both",{negotiated:!0,id:0});this.pc=l,this.dc=p,this.signal=d.signal,this.polite=a,this.signalingPort=r,this.ready=new Promise((e=>{p.addEventListener("open",(()=>{i=!0,c=e=>p.send(JSON.stringify(e)),r.close(),s.close(),this.ready=s=r=s.onmessage=null,e()}),{once:!0,...u})})),l.addEventListener("icecandidate",(({candidate:e})=>{i&&c({candidate:e})}),{...u});let m=!1,g=!1;async function f({data:t}){const{description:a,candidate:r}="string"==typeof t?JSON.parse(t):t;if(a){const t="offer"===a.type&&(m||"stable"!==l.signalingState);if(g=!this.polite&&t,g)return;if(t)await Promise.all([l.setLocalDescription({type:"rollback"}),l.setRemoteDescription(a)]);else try{"answer"===a.type&&"stable"===l.signalingState||await l.setRemoteDescription(a)}catch(e){}if("offer"===a.type){const t=await l.createAnswer();t.sdp=n(t.sdp,o),await l.setLocalDescription(t),i||await e(l,"new"),c({description:l.localDescription})}}else r&&await l.addIceCandidate(r)}l.addEventListener("negotiationneeded",(async()=>{m=!0;const t=await l.createOffer();if("stable"===l.signalingState)if(t.sdp=n(t.sdp,o),await l.setLocalDescription(t),m=!1,i)c({description:l.localDescription});else{await e(l);const t=l.localDescription.toJSON();t.sdp=t.sdp.replace(/a=ice-options:trickle\s\n/g,""),c({description:t})}}),{...u}),s.onmessage=f.bind(this),p.addEventListener("message",f.bind(this),{...u})}}function n(e,t={}){if(!e||!t.video&&!t.audio)return e;let n=e;if(t.video){const a=e.matchAll(/^m=video.*SAVPF (.*)$/gm).next().value;if(a&&a[1]){const i=a[1],o={};let r=null;for(const[a,i,s]of[...e.matchAll(/^a=rtpmap:(\d{1,3}) (.*)\/90000$/gm)])if("rtx"===s)o[r].push(i);else if(o[s]||(o[s]=[]),o[s].push(i),r=s,t.video.bitrate){const e=`a=fmtp:${i} x-google-min-bitrate=${t.video.bitrate}; x-google-max-bitrate=${t.video.bitrate}\n`;n=n.replace(a,e+a)}const s=Object.entries(o).sort(((e,n)=>{const a=t.video.codecs.indexOf(e[0]),i=t.video.codecs.indexOf(n[0]);return(-1===a?t.video.codecs.length:a)-(-1===i?t.video.codecs.length:i)})).map((e=>e[1].join(" "))).join(" ");n=n.replace(i,s)}}if(t.audio){const a=e.matchAll(/^a=rtpmap:(\d{1,3}) opus\/48000\/2$/gm).next().value;if(a&&a[0]){const i=new RegExp(`^a=fmtp:${a[1]}.*$`,"gm"),o=e.match(i);if(o&&o[0]){let e=o[0].slice(0,o[0].indexOf(" ")+1);e+="stereo="+(null!=t.audio.stereo?t.audio.stereo:"1"),e+=";sprop-stereo="+(null!=t.audio["sprop-stereo"]?t.audio["sprop-stereo"]:"1"),null!=t.audio.maxaveragebitrate&&(e+="; maxaveragebitrate="+(t.audio.maxaveragebitrate||1048576)),null!=t.audio.maxplaybackrate&&(e+="; maxplaybackrate="+(t.audio.maxplaybackrate||1048576)),null!=t.audio.cbr&&(e+="; cbr="+t.audio.cbr),null!=t.audio.useinbandfec&&(e+="; useinbandfec="+t.audio.useinbandfec),null!=t.audio.usedtx&&(e+="; usedtx="+t.audio.usedtx),null!=t.audio.maxptime&&(e+=";maxptime:"+t.audio.maxptime),null!=t.audio.minptime&&(e+="; minptime:"+t.audio.minptime),n=n.replace(o[0],e)}}}return n}function a(e,t){if(isNaN(e)||e<0)return t?"00:00":"0:00";const n=Math.floor(e/3600);let a=Math.floor(e/60)-60*n,i=Math.floor(e%60);return t&&a<10&&(a="0"+a),i<10&&(i="0"+i),n>0?n+":"+a+":"+i:a+":"+i}let i=null;const o=document.querySelector("audio"),r=document.querySelector(".duration"),s=document.querySelector(".current"),c=document.querySelector(".artist"),l=document.querySelector(".title"),d=document.querySelector(".cover"),u=document.querySelector(".backdrop"),p=document.querySelector("progress");function m(e){i=new t({polite:!1,quality:{audio:{stereo:1,"sprop-stereo":1,maxaveragebitrate:51e4,maxplaybackrate:51e4,cbr:0,useinbandfec:1,usedtx:1,maxptime:20,minptime:10}}}),i.pc.ontrack=e=>{e.receiver.playoutDelayHint=.1,o.srcObject=e.streams[0],o.volume=1,o.play()};const n=i.pc.createDataChannel("current",{negotiated:!0,id:2});let m,g=[];n.onmessage=({data:e})=>{if(e instanceof ArrayBuffer)g.push(e);else{const t=JSON.parse(e);t.duration&&(m=t.duration,r.textContent=a(t.duration)),t.current&&(s.textContent=a(t.current)),t.artist&&(c.textContent=t.artist),t.title&&(l.textContent=t.title),t.ended&&function(){const e=new Blob(g),t=URL.createObjectURL(e);d.src=t,u.src=t,g=[]}(),t.current&&m&&(p.value=t.current/m)}},i.signalingPort.onmessage=({data:t})=>{e.send(t)},e.addEventListener("message",(({data:e})=>{i.signalingPort.postMessage(e)}))}navigator.presentation.receiver&&navigator.presentation.receiver.connectionList.then((e=>{e.connections.map((e=>m(e))),e.addEventListener("connectionavailable",(e=>{m(e.connection)}))}))})();
//# sourceMappingURL=cast.js.map