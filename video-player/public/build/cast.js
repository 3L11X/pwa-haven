(()=>{"use strict";function e(e,t=e.iceGatheringState){return"complete"!==t&&new Promise((t=>{e.addEventListener("icegatheringstatechange",(()=>"complete"===e.iceGatheringState&&t()))}))}class t{constructor(t={}){let{polite:a=!0,trickle:n=!0,quality:o={}}=t,{port1:s,port2:c}=new MessageChannel,r=e=>c.postMessage(JSON.stringify(e));const l=new RTCPeerConnection({iceServers:t?.iceServers||[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]}),d=new AbortController,p={signal:d.signal};l.addEventListener("iceconnectionstatechange",(()=>{"disconnected"!==l.iceConnectionState&&"failed"!==l.iceConnectionState||d.abort()}),p);const u=l.createDataChannel("both",{negotiated:!0,id:0});this.pc=l,this.dc=u,this.signal=d.signal,this.polite=a,this.signalingPort=s,this.ready=new Promise((e=>{u.addEventListener("open",(()=>{n=!0,r=e=>u.send(JSON.stringify(e)),s.close(),c.close(),this.ready=c=s=c.onmessage=null,e()}),{once:!0,...p})})),l.addEventListener("icecandidate",(({candidate:e})=>{n&&r({candidate:e})}),{...p});let m=!1,g=!1;async function f({data:t}){const{description:a,candidate:s}="string"==typeof t?JSON.parse(t):t;if(a){const t="offer"===a.type&&(m||"stable"!==l.signalingState);if(g=!this.polite&&t,g)return;if(t)await Promise.all([l.setLocalDescription({type:"rollback"}),l.setRemoteDescription(a)]);else try{"answer"===a.type&&"stable"===l.signalingState||await l.setRemoteDescription(a)}catch(e){}if("offer"===a.type){const t=await l.createAnswer();t.sdp=i(t.sdp,o),await l.setLocalDescription(t),n||await e(l,"new"),r({description:l.localDescription})}}else s&&await l.addIceCandidate(s)}l.addEventListener("negotiationneeded",(async()=>{m=!0;const t=await l.createOffer();if("stable"===l.signalingState)if(t.sdp=i(t.sdp,o),await l.setLocalDescription(t),m=!1,n)r({description:l.localDescription});else{await e(l);const t=l.localDescription.toJSON();t.sdp=t.sdp.replace(/a=ice-options:trickle\s\n/g,""),r({description:t})}}),{...p}),c.onmessage=f.bind(this),u.addEventListener("message",f.bind(this),{...p})}}function i(e,t={}){if(!e||!t.video&&!t.audio)return e;let i=e;if(t.video){const a=e.matchAll(/^m=video.*SAVPF (.*)$/gm).next().value;if(a&&a[1]){const n=a[1],o={};let s=null;for(const[a,n,c]of[...e.matchAll(/^a=rtpmap:(\d{1,3}) (.*)\/90000$/gm)])if("rtx"===c)o[s].push(n);else if(o[c]||(o[c]=[]),o[c].push(n),s=c,t.video.bitrate){const e=`a=fmtp:${n} x-google-min-bitrate=${t.video.bitrate}; x-google-max-bitrate=${t.video.bitrate}\n`;i=i.replace(a,e+a)}const c=Object.entries(o).sort(((e,i)=>{const a=t.video.codecs.indexOf(e[0]),n=t.video.codecs.indexOf(i[0]);return(-1===a?t.video.codecs.length:a)-(-1===n?t.video.codecs.length:n)})).map((e=>e[1].join(" "))).join(" ");i=i.replace(n,c)}}if(t.audio){const a=e.matchAll(/^a=rtpmap:(\d{1,3}) opus\/48000\/2$/gm).next().value;if(a&&a[0]){const n=new RegExp(`^a=fmtp:${a[1]}.*$`,"gm"),o=e.match(n);if(o&&o[0]){let e=o[0].slice(0,o[0].indexOf(" ")+1);e+="stereo="+(null!=t.audio.stereo?t.audio.stereo:"1"),e+=";sprop-stereo="+(null!=t.audio["sprop-stereo"]?t.audio["sprop-stereo"]:"1"),null!=t.audio.maxaveragebitrate&&(e+="; maxaveragebitrate="+(t.audio.maxaveragebitrate||1048576)),null!=t.audio.maxplaybackrate&&(e+="; maxplaybackrate="+(t.audio.maxplaybackrate||1048576)),null!=t.audio.cbr&&(e+="; cbr="+t.audio.cbr),null!=t.audio.useinbandfec&&(e+="; useinbandfec="+t.audio.useinbandfec),null!=t.audio.usedtx&&(e+="; usedtx="+t.audio.usedtx),null!=t.audio.maxptime&&(e+=";maxptime:"+t.audio.maxptime),null!=t.audio.minptime&&(e+="; minptime:"+t.audio.minptime),i=i.replace(o[0],e)}}}return i}let a=null;const n=document.querySelector("video");function o(e){a=new t({polite:!1,quality:{audio:{stereo:1,"sprop-stereo":1,maxaveragebitrate:51e4,maxplaybackrate:51e4,cbr:0,useinbandfec:1,usedtx:1,maxptime:20,minptime:10},video:{bitrate:2e6,codecs:["VP9","VP8","H264"]}}}),a.pc.ontrack=e=>{e.receiver.playoutDelayHint=.5,n.srcObject||(n.srcObject=e.streams[0],n.volume=1,n.play())},a.signalingPort.onmessage=({data:t})=>{e.send(t)},e.addEventListener("message",(({data:e})=>{a.signalingPort.postMessage(e)}))}navigator.presentation.receiver&&navigator.presentation.receiver.connectionList.then((e=>{e.connections.map((e=>o(e))),e.addEventListener("connectionavailable",(e=>{o(e.connection)}))}))})();
//# sourceMappingURL=cast.js.map